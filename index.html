<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LeadFlow India</title>
    <!-- Tailwind CSS (CDN used for development only; use npm/PostCSS or Tailwind CLI for production) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* ...existing styles... */
    </style>
</head>
<body>

    <!-- Superuser Creation Modal -->
    <div id="superuserModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Create Superuser Account</h2>
            <form id="superuserForm" class="space-y-4">
                <input type="text" id="suName" class="w-full border rounded p-2" placeholder="Full Name" required />
                <input type="text" id="suUsername" class="w-full border rounded p-2" placeholder="Username" required />
                <input type="password" id="suPassword" class="w-full border rounded p-2" placeholder="Password" required />
                <button type="submit" class="w-full bg-primary text-white font-bold py-2 rounded">Create Superuser</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Lead Modal -->
    <div id="leadModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <!-- ...existing code for lead modal... -->
    </div>

    <!-- SIDE MENU -->
    <div id="sideMenu" class="fixed inset-0 z-[60] hidden" role="dialog">
        <!-- ...existing code for side menu... -->
    </div>

    <!-- Logs Modal -->
    <div id="logsModal" class="fixed inset-0 z-[70] hidden" role="dialog" aria-modal="true">
        <!-- ...existing code for logs modal... -->
    </div>

    <!-- User Config / Management Modal (moved to end of body for guaranteed z-index) -->
    <div id="configModal" class="fixed inset-0 z-[70] hidden" role="dialog" aria-modal="true">
        <!-- ...existing code for config modal... -->
    </div>

    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#4f46e5', secondary: '#64748b', } } } }
    </script>
    <script>
        // Main app logic (LeadStore, App, ui, DOMContentLoaded, etc.)
        class LeadStore {
            constructor() {
                this.subscribers = [];
                this.STORAGE_KEY = 'LEAD_FLOW_DB_V27'; 
                const data = this.loadLocal();
                this.state = data.leads || [];
                this.logs = data.logs || [];
                this.config = data.config || { appTitle: 'LeadFlow', dbUrl: '' };
                this.users = data.users || [];
                this.interests = data.interests || []; 
                this.settings = data.settings || { locations: [], sources: [] };
                // Only show modal for superuser creation if users is empty (handled below)
            }
            subscribe(callback) { this.subscribers.push(callback); }
            notify() { this.subscribers.forEach(cb => cb(this.state)); }
            generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
            loadLocal() { try { return JSON.parse(localStorage.getItem(this.STORAGE_KEY)) || {}; } catch(e) { return {}; } }
            saveLocal() {
                const data = { leads: this.state, logs: this.logs, config: this.config, users: this.users, interests: this.interests, settings: this.settings };
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                this.notify();
            }
            async syncWithCloud() {
                if (!this.config.dbUrl) {
                    console.error('syncWithCloud: No dbUrl configured');
                    document.getElementById('loginError').textContent = 'Debug: No Script URL (dbUrl) configured.';
                    document.getElementById('loginError').classList.remove('hidden');
                    return;
                }
                ui.showLoading(true);
                try {
                    console.log('syncWithCloud: Fetching from', this.config.dbUrl);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                    const response = await fetch(this.config.dbUrl, { method: 'GET', redirect: 'follow', credentials: 'omit', signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                    const cloudData = await response.json();
                    console.log('syncWithCloud: Received data', cloudData);
                    if (cloudData.leads) this.state = cloudData.leads;
                    if (cloudData.users && cloudData.users.length > 0) {
                        this.users = cloudData.users;
                    } else {
                        console.error('syncWithCloud: No users array or empty users from backend', cloudData.users);
                        document.getElementById('loginError').textContent = 'Debug: No users returned from backend.';
                        document.getElementById('loginError').classList.remove('hidden');
                    }
                    if (cloudData.logs) this.logs = cloudData.logs;
                    if (cloudData.interests) this.interests = cloudData.interests;
                    if (cloudData.settings) this.settings = cloudData.settings; 
                    this.saveLocal(); 
                } catch (e) {
                    console.error("Sync Read Failed", e);
                    document.getElementById('loginError').textContent = 'Debug: Sync failed - ' + e;
                    document.getElementById('loginError').classList.remove('hidden');
                } finally { ui.showLoading(false); }
            }
            async pushToCloud() {
                if (!this.config.dbUrl) return;
                ui.showLoading(true);
                try {
                    const payload = { action: 'save_all', leads: this.state, users: this.users, logs: this.logs };
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                    await fetch(this.config.dbUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload), signal: controller.signal });
                    clearTimeout(timeoutId);
                } catch (e) { console.error("Sync Write Failed", e); } finally { ui.showLoading(false); }
            }
            save() { this.saveLocal(); this.pushToCloud(); }
            getCounts() { return { admins: this.users.filter(u => u.role === 'admin').length, agents: this.users.filter(u => u.role === 'agent').length }; }
            addUser(user) { this.users.push({id: this.generateId(), ...user}); this.save(); }
            // Only one deleteUser method should exist, keep the latest/most correct one
            deleteUser(id) {
                const u = this.users.find(x => x.id === id);
                if (u && u.role === 'superuser') return false;
                this.users = this.users.filter(x => x.id !== id);
                this.save();
                return true;
            }
            async saveConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                this.saveLocal();
                // If superuser sets dbUrl or appTitle, save to backend for all users
                if ((this.config.dbUrl || this.config.appTitle) && window.app && window.app.currentUser && window.app.currentUser.role === 'superuser') {
                    try {
                        await fetch(this.config.dbUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ action: 'save_script_url', scriptUrl: this.config.dbUrl, appTitle: this.config.appTitle })
                        });
                    } catch (e) { /* ignore */ }
                }
                if (this.config.dbUrl) this.syncWithCloud();
            }
            async pushToCloud() {
                if (!this.config.dbUrl) return;
                ui.showLoading(true);
                try {
                    const payload = { action: 'save_all', leads: this.state, users: this.users, logs: this.logs };
                    await fetch(this.config.dbUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
                } catch (e) { console.error("Sync Write Failed", e); } finally { ui.showLoading(false); }
            }
            save() { this.saveLocal(); this.pushToCloud(); }
            getCounts() { return { admins: this.users.filter(u => u.role === 'admin').length, agents: this.users.filter(u => u.role === 'agent').length }; }
            addUser(user) { this.users.push({id: this.generateId(), ...user}); this.save(); }
            deleteUser(id) { const u = this.users.find(x => x.id === id); if (u && u.role === 'superuser') return false; this.users = this.users.filter(x => x.id !== id); this.save(); return true; }
            async saveConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                this.saveLocal();
                // If superuser sets dbUrl or appTitle, save to backend for all users
                if ((this.config.dbUrl || this.config.appTitle) && window.app && window.app.currentUser && window.app.currentUser.role === 'superuser') {
                    try {
                        await fetch(this.config.dbUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ action: 'save_script_url', scriptUrl: this.config.dbUrl, appTitle: this.config.appTitle })
                        });
                    } catch (e) { /* ignore */ }
                }
                if (this.config.dbUrl) this.syncWithCloud();
            }
            log(msg, user) { const prefix = user ? `${user.name} (${user.role}): ` : 'System: '; this.logs.unshift({ id: this.generateId(), timestamp: new Date().toISOString(), message: prefix + msg }); if (this.logs.length > 50) this.logs.pop(); this.save(); }
            add(data, user) { this.state.push({ id: this.generateId(), createdAt: new Date().toISOString(), activities: [], ...data }); this.log(`Created lead ${data.name}`, user); this.save(); }
            update(id, data, user) { const idx = this.state.findIndex(l => l.id === id); if (idx !== -1) { this.state[idx] = { ...this.state[idx], ...data }; this.log(`Updated ${data.name}`, user); this.save(); } }
            delete(id, user) { const l = this.state.find(x => x.id === id); this.state = this.state.filter(x => x.id !== id); this.log(`Deleted ${l ? l.name : 'Lead'}`, user); this.save(); }
            updateStatus(id, status, user) { const l = this.state.find(x => x.id === id); if (l) { l.status = status; this.log(`Moved ${l.name} to ${status}`, user); this.save(); } }
            addActivity(id, activity, user) { const l = this.state.find(x => x.id === id); if (l) { if(!l.activities) l.activities = []; l.activities.unshift({ id: this.generateId(), timestamp: new Date().toISOString(), createdBy: user ? user.name : 'System', role: user ? user.role : '', ...activity }); this.log(`Logged activity for ${l.name}`, user); this.save(); } }
            reset() { this.state = []; this.logs = []; this.save(); }
        }

        class App {
            constructor(store) {
                this.store = store || window.store;
                // Default Kanban status columns
                this.statusConfig = [
                    { id: "New", color: "bg-blue-400" },
                    { id: "Contacted", color: "bg-yellow-400" },
                    { id: "Qualified", color: "bg-green-400" },
                    { id: "Lost", color: "bg-red-400" }
                ];
                this.activeView = "kanban";
                this.activeMobileTab = this.statusConfig[0].id;
            }
            // Render the leads table view
                                                renderTable(leads) {
                                                    const tbody = document.getElementById('tableBody');
                                                    if (!tbody) return;
                                                    tbody.innerHTML = leads.map(lead => `
                                                        <tr class="table-row-hover">
                                                            <td class="pl-4 py-2 font-bold">${this.escapeHtml(lead.name)}</td>
                                                            <td class="py-2">${this.escapeHtml(lead.phone || '')}<br><span class="text-xs text-slate-400">${this.escapeHtml(lead.email || '')}</span></td>
                                                            <td class="py-2">${this.escapeHtml(lead.status)}</td>
                                                            <td class="py-2">${this.escapeHtml(lead.interest)}</td>
                                                            <td class="py-2">${this.escapeHtml(lead.source)}</td>
                                                            <td class="py-2">${this.escapeHtml(lead.assignedTo)}</td>
                                                            <td class="py-2 text-right pr-4">${this.formatCurrency(lead.value)}</td>
                                                            <td class="py-2 text-right">
                                                                <button onclick="app.editLead('${lead.id}')" class="text-primary hover:underline text-xs font-bold">Edit</button>
                                                            </td>
                                                        </tr>
                                                    `).join('');
                                                }
                                    // Switch between Kanban and Table views
                                    switchViewMode(mode) {
                                        this.activeView = mode;
                                        const kanban = document.getElementById('kanbanView');
                                        const table = document.getElementById('tableView');
                                        if (mode === 'kanban') {
                                            kanban.classList.remove('hidden');
                                            table.classList.add('hidden');
                                        } else if (mode === 'table') {
                                            kanban.classList.add('hidden');
                                            table.classList.remove('hidden');
                                        }
                                        this.render(this.store.state);
                                    }
                        // Render the activity timeline for a lead in the modal
                        renderTimeline(lead) {
                            const container = document.getElementById('activityTimeline');
                            if (!container || !lead || !Array.isArray(lead.activities)) {
                                container.innerHTML = '<div class="text-slate-400 text-sm">No activity yet.</div>';
                                return;
                            }
                            if (lead.activities.length === 0) {
                                container.innerHTML = '<div class="text-slate-400 text-sm">No activity yet.</div>';
                                return;
                            }
                            container.innerHTML = lead.activities.map(a => `
                                <div class="timeline-item relative pl-8 py-4">
                                    <div class="timeline-line absolute left-0 top-0 h-full w-4 flex items-center justify-center">
                                        <div class="w-2 h-2 rounded-full bg-primary"></div>
                                    </div>
                                    <div class="flex flex-col gap-1">
                                        <div class="text-xs text-slate-500">${a.timestamp ? new Date(a.timestamp).toLocaleString() : ''}</div>
                                        <div class="text-sm font-medium text-slate-800">${this.escapeHtml(a.type || '')}${a.note ? ': ' + this.escapeHtml(a.note) : ''}</div>
                                        <div class="text-xs text-slate-400">${a.createdBy ? this.escapeHtml(a.createdBy) : ''}${a.role ? ' (' + this.escapeHtml(a.role) + ')' : ''}</div>
                                    </div>
                                </div>
                            `).join('');
                        }
            // Populate Assigned To dropdown with Admins and Agents
            populateAssignedToDropdown() {
                const select = document.getElementById('assignedToSelect');
                if (!select) return;
                const current = select.value;
                select.innerHTML = '<option value="">Select User</option>';
                this.store.users.filter(u => u.role === 'admin' || u.role === 'agent').forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.username || u.id;
                    opt.textContent = u.name;
                    select.appendChild(opt);
                });
                if (current) select.value = current;
            }

            // --- EDIT LEAD LOGIC ---
            editLead(id, tab) {
                const lead = this.store.state.find(l => l.id === id);
                if (!lead) return;
                // Fill modal form fields
                document.getElementById('leadIdInput').value = lead.id;
                document.getElementById('modalTitle').textContent = 'Edit Lead';
                document.getElementById('submitBtn').textContent = 'Update';
                document.getElementById('tab-btn-activity').disabled = false;
                document.getElementById('tab-btn-contact').disabled = false;
                document.getElementById('leadForm').name.value = lead.name || '';
                document.getElementById('leadForm').interest.value = lead.interest || '';
                document.getElementById('leadForm').value.value = lead.value || '';
                document.getElementById('leadForm').status.value = lead.status || '';
                document.getElementById('leadForm').email.value = lead.email || '';
                document.getElementById('leadForm').location.value = lead.location || '';
                document.getElementById('leadForm').source.value = lead.source || '';
                // Assigned To select
                this.populateAssignedToDropdown();
                const assignedToSelect = document.getElementById('assignedToSelect');
                if (assignedToSelect) assignedToSelect.value = lead.assignedTo || '';
                // Phone split
                let phone = lead.phone || '';
                let prefix = '+91', number = '';
                if (phone.startsWith('+')) {
                    const parts = phone.split(' ');
                    prefix = parts[0];
                    number = parts.slice(1).join(' ');
                } else if (phone) {
                    number = phone;
                }
                document.getElementById('leadForm').phonePrefix.value = prefix;
                document.getElementById('leadForm').phone.value = number;
                document.getElementById('leadForm').notes.value = lead.notes || '';
                // Interests tags
                this.selectedInterests = (lead.interest || '').split(',').filter(x=>x.trim()).map(i=>({name:i.trim(),value:0}));
                this.renderInterestTags();
                // Show modal
                ui.toggleModal(true);
                // Switch tab if specified
                if (tab) this.switchModalTab(tab);
            }


            // --- AUTOCOMPLETE LOGIC (Generic) ---
            setupAutocomplete(inputId, suggestionsId, dataList, onSelect) {
                const input = document.getElementById(inputId);
                const suggestions = document.getElementById(suggestionsId);
                if (!input || !suggestions) return;
                
                input.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    if (!val) { suggestions.classList.add('hidden'); return; }
                    
                    const matches = dataList.filter(i => {
                        const text = typeof i === 'string' ? i : i.name;
                        return text.toLowerCase().includes(val);
                    });

                    if (matches.length > 0) {
                        suggestions.innerHTML = matches.map(m => {
                            const text = typeof m === 'string' ? m : m.name;
                            const subtext = typeof m === 'string' ? '' : `â‚¹${m.value.toLocaleString('en-IN')}`;
                            return `<div class="suggestion-item" data-val="${text}">${text} <span class="text-xs text-slate-400 float-right">${subtext}</span></div>`;
                        }).join('');
                        suggestions.classList.remove('hidden');
                        
                        const items = suggestions.querySelectorAll('.suggestion-item');
                        items.forEach((item, index) => {
                            item.addEventListener('click', () => {
                                const selected = matches[index];
                                onSelect(selected);
                                suggestions.classList.add('hidden');
                            });
                        });
                    } else {
                        suggestions.classList.add('hidden');
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                        suggestions.classList.add('hidden');
                    }
                });
            }

            // --- INTEREST LOGIC ---
            initInterestLogic() {
                const getMasterList = () => {
                    if (this.store.interests && this.store.interests.length > 0) {
                        return this.store.interests.map(i => ({ 
                            name: i.Name || i.name, 
                            value: parseFloat(i.Value || i.value) || 0 
                        }));
                    }
                    return [];
                };
                
                const input = document.getElementById('interestInput');
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); if (input.value.trim()) this.addInterest(input.value.trim(), 0); }
                });

                this.setupAutocomplete('interestInput', 'interestSuggestions', getMasterList(), (selected) => {
                    this.addInterest(selected.name, selected.value);
                    document.getElementById('interestInput').value = ''; 
                });
            }

            addInterest(name, value) {
                if (this.selectedInterests.some(i => i.name === name)) return;
                this.selectedInterests.push({ name, value });
                this.renderInterestTags();
                this.updateTotalValue();
            }
            removeInterest(name) {
                this.selectedInterests = this.selectedInterests.filter(i => i.name !== name);
                this.renderInterestTags();
                this.updateTotalValue();
            }
            renderInterestTags() {
                const container = document.getElementById('interestTags');
                const hiddenInput = document.getElementById('interestHidden');
                container.innerHTML = this.selectedInterests.map(i => `
                    <span class="interest-tag inline-flex items-center px-2.5 py-1 rounded-md text-sm font-medium bg-indigo-50 text-indigo-700 border border-indigo-100">
                        ${i.name}
                        <button type="button" onclick="app.removeInterest('${i.name}')" class="ml-1.5 text-indigo-400 hover:text-indigo-600 focus:outline-none"><i class="ph-bold ph-x"></i></button>
                    </span>`).join('');
                hiddenInput.value = this.selectedInterests.map(i => i.name).join(', ');
            }
            updateTotalValue() {
                const total = this.selectedInterests.reduce((sum, item) => sum + item.value, 0);
                if (total > 0) document.getElementById('leadValue').value = total;
            }

            // --- LOCATION & SOURCE LOGIC ---
            initSettingsAutocomplete() {
                const locations = this.store.settings.locations || [];
                const sources = this.store.settings.sources || [];

                this.setupAutocomplete('locationInput', 'locationSuggestions', locations, (selected) => {
                    document.getElementById('locationInput').value = selected;
                });

                this.setupAutocomplete('sourceInput', 'sourceSuggestions', sources, (selected) => {
                    document.getElementById('sourceInput').value = selected;
                });
            }

            // --- STANDARD LOGIC ---

            handleLogin(e) {
                e.preventDefault();
                const loginError = document.getElementById('loginError');
                // Forced initialization if missing
                if (!window.store) {
                    window.store = new LeadStore();
                    loginError.textContent = 'Debug: Forced creation of window.store.';
                    loginError.classList.remove('hidden');
                }
                if (!window.app) {
                    window.app = this;
                    if (!this.store && window.store) {
                        this.store = window.store;
                        loginError.textContent = 'Debug: Forced creation of window.app and set this.store = window.store.';
                    } else {
                        loginError.textContent = 'Debug: Forced creation of window.app.';
                    }
                    loginError.classList.remove('hidden');
                }
                let storeToUse = this.store || window.store;
                if (!storeToUse || !storeToUse.users) {
                    loginError.textContent = 'App error: User store not loaded. this.store=' + JSON.stringify(this.store) + ', window.store=' + JSON.stringify(window.store);
                    loginError.classList.remove('hidden');
                    return;
                }
                // Debug output: show users array at login time
                loginError.textContent = 'Debug: Users at login: ' + JSON.stringify(storeToUse.users);
                loginError.classList.remove('hidden');
                const u = e.target.username.value;
                const p = e.target.password.value;
                const user = storeToUse.users.find(x => String(x.username) === String(u) && String(x.password) === String(p));
                if (user) {
                    this.currentUser = user;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('appContent').classList.remove('hidden');
                    document.getElementById('appContent').classList.add('flex');
                    this.init();
                } else {
                    // Try syncing with cloud again in case users were just added
                    storeToUse.syncWithCloud().then(() => {
                        const userRetry = storeToUse.users.find(x => String(x.username) === String(u) && String(x.password) === String(p));
                        if (userRetry) {
                            this.currentUser = userRetry;
                            document.getElementById('loginScreen').classList.add('hidden');
                            document.getElementById('appContent').classList.remove('hidden');
                            document.getElementById('appContent').classList.add('flex');
                            this.init();
                        } else {
                            loginError.textContent = 'Debug: Users after sync: ' + JSON.stringify(storeToUse.users);
                            loginError.classList.remove('hidden');
                        }
                    });
                }
            }

            logout() { location.reload(); }

            async init() {
                // Always ensure this.store is set to window.store
                this.store = window.store;
                // If dbUrl or appTitle is missing, try to fetch from backend (public endpoint)
                if (!this.store.config.dbUrl || !this.store.config.appTitle) {
                    try {
                        let backendUrl = window.INIT_SCRIPT_URL || 'https://script.google.com/macros/s/AKfycbzHItA0cJehn2LiFmHaMDTftl6jPsI1Ffwtd9Gkfoo0c5g_LFBQN1lICHHai3qXn7nZPA/exec';
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                        const resp = await fetch(backendUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        const data = await resp.json();
                        if (data.settings && data.settings.scriptUrl) {
                            this.store.config.dbUrl = data.settings.scriptUrl;
                        }
                        if (data.settings && data.settings.appTitle) {
                            this.store.config.appTitle = data.settings.appTitle;
                        }
                        this.store.saveLocal();
                    } catch (e) { /* ignore */ }
                }
                this.applyConfig();
                this.updateUserUI();
                this.renderTabs();
                this.render(this.store.state);

                this.initInterestLogic();
                this.initSettingsAutocomplete();
                this.populateAssignedToDropdown();

                if (this.currentUser && (this.currentUser.role === 'superuser' || this.currentUser.role === 'admin')) {
                    const btnUserConfig = document.getElementById('btnUserConfig');
                    if (btnUserConfig) {
                        btnUserConfig.classList.remove('hidden');
                        btnUserConfig.classList.add('flex');
                    }
                }

                if (this.store.config.dbUrl) {
                    await this.store.syncWithCloud();
                    this.initInterestLogic(); 
                    this.initSettingsAutocomplete();
                    this.populateAssignedToDropdown();
                }

                const s = document.getElementById('formStatusSelect');
                s.innerHTML = '';
                this.statusConfig.forEach(x => {
                    const opt = document.createElement('option');
                    opt.value = x.id; opt.textContent = x.id; s.appendChild(opt);
                });
            }

            sync() { this.store.syncWithCloud(); }
            updateUserUI() {
                if (!this.currentUser) return;
                const userDisplay = document.getElementById('currentUserDisplay');
                if (userDisplay) userDisplay.textContent = this.currentUser.username;
                const menuUserName = document.getElementById('menuUserName');
                if (menuUserName) menuUserName.textContent = this.currentUser.name;
                const menuUserRole = document.getElementById('menuUserRole');
                if (menuUserRole) menuUserRole.textContent = this.currentUser.role;
            }
            applyConfig() {
                const title = this.store.config.appTitle || 'LeadFlow';
                document.getElementById('appTitleDisplay').textContent = title;
                document.getElementById('configAppTitle').value = title;
                document.getElementById('configDbUrl').value = this.store.config.dbUrl || '';
            }

            handleAddUser(e) {
                e.preventDefault();
                const counts = this.store.getCounts();
                const role = e.target.newRole.value;
                if (role === 'admin' && counts.admins >= 2) return alert('Max 2 Admins');
                if (role === 'agent' && counts.agents >= 10) return alert('Max 10 Agents');
                this.store.addUser({ username: e.target.newUsername.value, password: e.target.newPassword.value, name: e.target.newName.value, role: role });
                e.target.reset(); this.renderUserList();
                this.populateAssignedToDropdown();
            }
            deleteUser(id) { if(confirm('Remove user?')) { if(!this.store.deleteUser(id)) alert('Cannot delete Superuser'); this.renderUserList(); } }
            renderUserList() {
                const c = document.getElementById('userListContainer');
                const counts = this.store.getCounts();
                document.getElementById('userLimitMsg').textContent = `Admins: ${counts.admins}/2 | Agents: ${counts.agents}/10`;
                c.innerHTML = this.store.users.map(u => `<div class="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-lg"><div><div class="font-bold text-sm text-slate-800">${u.name} <span class="text-xs text-slate-400">(${u.username})</span></div><div class="text-xs uppercase font-bold text-primary bg-primary/5 w-fit px-1.5 rounded mt-0.5">${u.role}</div></div>${u.role !== 'superuser' ? `<button onclick="app.deleteUser('${u.id}')" class="text-red-400 p-2"><i class="ph-bold ph-trash"></i></button>` : ''}</div>`).join('');
            }
            async handleSaveAppConfig(e) {
                // Always ensure this.store is set to window.store
                this.store = window.store;
                e.preventDefault();
                await this.store.saveConfig({ appTitle: e.target.appTitle.value, dbUrl: e.target.dbUrl.value });
                this.applyConfig();
                alert('Saved');
            }

            handleFormSubmit(e) {
                e.preventDefault();
                const f = e.target;
                const prefix = f.phonePrefix.value || '';
                const num = f.phone.value || '';
                const fullPhone = num ? (prefix + ' ' + num) : '';

                const d = {
                    name: f.name.value,
                    interest: f.interest.value,
                    value: parseFloat(f.value.value) || 0,
                    status: f.status.value,
                    email: f.email.value,
                    location: f.location.value,
                    source: f.source.value,
                    assignedTo: f.assignedTo.value,
                    phone: fullPhone,
                    notes: f.notes.value
                };
                if (f.leadId.value) this.store.update(f.leadId.value, d, this.currentUser);
                else this.store.add(d, this.currentUser);
                if (typeof this.switchTab === 'function') {
                    this.switchTab(d.status);
                }
                ui.toggleModal(false);
            }
            handleAddActivity(e) {
                e.preventDefault();
                const f = e.target;
                const id = document.getElementById('leadIdInput').value;
                const type = f.type.value;
                let note = f.noteText.value;
                if(type==='follow_up') note = f.noteDate.value;
                else if(type==='file') note = f.noteFile.files[0]?.name || 'File';
                
                if(id && note) {
                    this.store.addActivity(id, { type, note }, this.currentUser);
                    f.noteText.value = ''; f.noteDate.value = ''; f.noteFile.value = '';
                    this.renderTimeline(this.store.state.find(l => l.id === id));
                }
            }
            moveLead(id, s) { this.store.updateStatus(id, s, this.currentUser); }
            deleteLead(id) { 
                if(this.currentUser.role==='agent') return alert('Access Denied');
                if(confirm('Delete?')) this.store.delete(id, this.currentUser); 
            }
            editLead(id, tab) {
                const lead = this.store.state.find(l => l.id === id);
                if (!lead) return;
                // Fill modal form fields
                document.getElementById('leadIdInput').value = lead.id;
                document.getElementById('modalTitle').textContent = 'Edit Lead';
                document.getElementById('submitBtn').textContent = 'Update';
                document.getElementById('tab-btn-activity').disabled = false;
                document.getElementById('tab-btn-contact').disabled = false;
                document.getElementById('leadForm').name.value = lead.name || '';
                document.getElementById('leadForm').interest.value = lead.interest || '';
                document.getElementById('leadForm').value.value = lead.value || '';
                document.getElementById('leadForm').status.value = lead.status || '';
                document.getElementById('leadForm').email.value = lead.email || '';
                document.getElementById('leadForm').location.value = lead.location || '';
                document.getElementById('leadForm').source.value = lead.source || '';
                // Assigned To select
                this.populateAssignedToDropdown();
                const assignedToSelect = document.getElementById('assignedToSelect');
                if (assignedToSelect) assignedToSelect.value = lead.assignedTo || '';
                // Phone split
                let phone = lead.phone || '';
                let prefix = '+91', number = '';
                if (phone.startsWith('+')) {
                    const parts = phone.split(' ');
                    prefix = parts[0];
                    number = parts.slice(1).join(' ');
                } else if (phone) {
                    number = phone;
                }
                document.getElementById('leadForm').phonePrefix.value = prefix;
                document.getElementById('leadForm').phone.value = number;
                document.getElementById('leadForm').notes.value = lead.notes || '';
                // Interests tags
                this.selectedInterests = (lead.interest || '').split(',').filter(x=>x.trim()).map(i=>({name:i.trim(),value:0}));
                this.renderInterestTags();
                // Show modal
                ui.toggleModal(true);
                // Switch tab if specified
                if (tab) this.switchModalTab(tab);
            }
            renderTabs() { document.getElementById('mobileTabs').innerHTML = this.statusConfig.map(s => `<button onclick="app.switchTab('${s.id}')" class="px-4 py-2 rounded-full text-sm font-semibold border ${this.activeMobileTab === s.id ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200'}">${s.id}</button>`).join(''); }
            
            render(leads) {
                if (this.activeView === 'table') { this.renderTable(leads); return; }
                const b = document.getElementById('boardContainer'); b.innerHTML = '';
                this.statusConfig.forEach(s => {
                    const sl = leads.filter(l => l.status === s.id);
                    const sum = sl.reduce((a,c) => a + (c.value||0), 0);
                    const hide = this.activeMobileTab !== s.id ? 'hidden md:flex' : 'flex';
                    b.innerHTML += `
                        <div class="kanban-column ${hide} flex-col h-full w-full md:w-80 md:bg-slate-100 md:rounded-xl md:border md:border-slate-200 overflow-hidden shrink-0">
                            <div class="px-4 py-3 md:bg-white md:border-b md:border-slate-200 flex justify-between items-center shrink-0">
                                <div class="flex items-center gap-2"><div class="w-2.5 h-2.5 rounded-full ${s.color}"></div><h2 class="font-bold text-slate-700">${s.id}</h2></div>
                                <span class="bg-slate-200 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full">${sl.length}</span>
                            </div>
                            <div class="flex-1 overflow-y-auto p-3 space-y-3 overscroll-contain">
                                ${sl.length===0 ? '<div class="flex flex-col items-center justify-center h-48 text-slate-400 opacity-60"><i class="ph-duotone ph-ghost text-4xl mb-2"></i><p class="text-sm">Empty</p></div>' : sl.map(l => this.createCardHTML(l)).join('')}
                                <div class="h-20 md:hidden"></div>
                            </div>
                            <div class="bg-white/50 border-t border-slate-200 p-2 text-center text-xs text-slate-500 font-medium">Total: ${this.formatCurrency(sum)}</div>
                        </div>`;
                });
            }

            createCardHTML(lead) {
                const idx = this.statusConfig.findIndex(s => s.id === lead.status);
                const prev = idx > 0 ? this.statusConfig[idx-1].id : null;
                const next = idx < this.statusConfig.length-1 ? this.statusConfig[idx+1].id : null;
                const delBtn = (this.currentUser.role==='admin' || this.currentUser.role==='superuser') ? `<button onclick="event.stopPropagation(); app.deleteLead('${lead.id}')" class="text-slate-300 hover:text-red-500 p-2 rounded-full active:bg-red-50"><i class="ph-bold ph-trash"></i></button>` : '';
                const rawPhone = lead.phone || '';
                let displayPhone = rawPhone;
                if (rawPhone && !rawPhone.includes('+')) displayPhone = '+91 ' + rawPhone; 
                
                const interests = lead.interest ? lead.interest.split(',').map(i => i.trim()) : [];
                const interestHTML = interests.length > 0 ? 
                    `<div class="flex flex-wrap gap-1 mb-2">${interests.slice(0, 2).map(i => `<span class="text-[10px] font-bold text-primary bg-primary/10 px-1.5 py-0.5 rounded border border-primary/20">${this.escapeHtml(i)}</span>`).join('')}${interests.length > 2 ? `<span class="text-[10px] text-slate-400">+${interests.length - 2}</span>` : ''}</div>` : '';

                return `
                    <div onclick="app.editLead('${lead.id}')" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 active:scale-[0.99] transition-transform cursor-pointer">
                        <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-slate-800 line-clamp-1 text-lg">${this.escapeHtml(lead.name)}</h3><div class="flex gap-1 -mr-2 -mt-2">${delBtn}</div></div>
                        ${interestHTML}
                        <div class="text-slate-500 font-medium text-sm mb-3">${this.formatCurrency(lead.value)}</div>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button onclick="event.stopPropagation(); app.editLead('${lead.id}', 'activity')" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-indigo-50 text-indigo-600 text-xs rounded-lg border border-indigo-100 active:bg-indigo-100 font-medium transition-colors"><i class="ph-bold ph-plus"></i> Activity</button>
                            ${lead.phone ? `<a href="tel:${lead.phone.replace(/\s+/g,'')}" onclick="event.stopPropagation()" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-slate-50 text-slate-600 text-xs rounded-lg border border-slate-200 active:bg-slate-200"><i class="ph-fill ph-phone"></i> Call</a><a href="https://wa.me/${lead.phone.replace(/\D/g,'')}" target="_blank" onclick="event.stopPropagation()" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-slate-50 text-slate-600 text-xs rounded-lg border border-slate-200 active:bg-slate-200 hover:text-green-600 hover:bg-green-50 hover:border-green-200 transition-colors"><i class="ph-fill ph-whatsapp-logo text-green-600"></i> WhatsApp</a>` : ''}
                        </div>
                        ${lead.notes ? `<div class="text-xs text-slate-500 bg-slate-50 p-2 rounded-lg mb-3 line-clamp-2">${this.escapeHtml(lead.notes)}</div>` : ''}
                        <div class="flex gap-2 mt-2 pt-2 border-t border-slate-50">
                            ${prev ? `<button onclick="event.stopPropagation(); app.moveLead('${lead.id}', '${prev}')" class="flex-1 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-semibold hover:bg-slate-200 transition"><i class="ph-bold ph-arrow-left"></i></button>` : '<div class="flex-1"></div>'}
                            ${next ? `<button onclick="event.stopPropagation(); app.moveLead('${lead.id}', '${next}')" class="flex-1 py-2 bg-primary/10 text-primary rounded-lg text-sm font-semibold hover:bg-primary/20 transition"><i class="ph-bold ph-arrow-right"></i></button>` : '<div class="flex-1"></div>'}
                        </div>
                    </div>`;
            }

            renderFollowUps() {
                const today = new Date().toISOString().split('T')[0];
                let od=[], td=[], uc=[];
                this.store.state.forEach(l => {
                    const f = l.activities?.find(a => a.type==='follow_up');
                    if(f && f.note) {
                        const d = { ...l, followUpDate: f.note };
                        if(f.note < today) od.push(d); else if(f.note === today) td.push(d); else uc.push(d);
                    }
                });
                const ri = (l) => `<button onclick="app.openLeadFromMenu('${l.id}')" class="w-full text-left px-4 py-3 hover:bg-slate-50 flex justify-between items-center group"><div><div class="font-bold text-slate-700 text-sm group-hover:text-primary">${this.escapeHtml(l.name)}</div><div class="text-xs text-slate-400 mt-0.5">${l.followUpDate}</div></div><i class="ph-bold ph-caret-right text-slate-300"></i></button>`;
                document.getElementById('count-overdue').textContent = od.length; document.getElementById('list-overdue').innerHTML = od.map(ri).join('');
                document.getElementById('count-today').textContent = td.length; document.getElementById('list-today').innerHTML = td.map(ri).join('');
                document.getElementById('count-upcoming').textContent = uc.length; document.getElementById('list-upcoming').innerHTML = uc.map(ri).join('');
            }

            renderLogs() {
                const c = document.getElementById('logsContainer');
                if(this.store.logs.length === 0) return c.innerHTML = '<div class="p-8 text-center text-slate-400"><p class="text-sm">No logs</p></div>';
                c.innerHTML = this.store.logs.map(l => `<div class="px-6 py-4 flex gap-3 hover:bg-white"><div class="flex-col pt-1"><div class="w-2 h-2 rounded-full bg-slate-300"></div></div><div><div class="text-xs text-slate-400 mb-0.5">${new Date(l.timestamp).toLocaleString()}</div><div class="text-sm text-slate-700 font-medium">${this.escapeHtml(l.message)}</div></div></div>`).join('');
            }

            switchModalTab(t) {
                this.currentModalTab = t;
                ['info','activity','contact'].forEach(x => {
                    document.getElementById(`tab-btn-${x}`).className = x===t ? 'tab-active pb-3 font-semibold text-sm transition-colors whitespace-nowrap' : 'tab-inactive pb-3 font-semibold text-sm transition-colors whitespace-nowrap';
                    document.getElementById(`view-${x}`).classList.toggle('hidden', x!==t);
                    if(document.getElementById(`footer-${x}`)) document.getElementById(`footer-${x}`).classList.toggle('hidden', x!==t);
                });
                // Render content for activity/contact tabs
                const leadId = document.getElementById('leadIdInput').value;
                const lead = this.store.state.find(l => l.id === leadId);
                if (t === 'activity' && lead) this.renderTimeline(lead);
                if (t === 'contact' && lead) this.renderContactView(lead);
            }

            renderContactView(lead) {
                const c = document.getElementById('contactActions');
                if(!lead.phone) return c.innerHTML = '<div class="text-center text-slate-400"><p>No Phone</p></div>';
                const phoneStr = String(lead.phone || '');
                const cp = phoneStr.replace(/\D/g, '');
                c.innerHTML = `
                    <a href="tel:+91${cp}" class="w-full bg-green-500 text-white rounded-2xl py-6 flex flex-col items-center justify-center gap-2 shadow-lg active:scale-95 transition"><i class="ph-fill ph-phone text-4xl"></i><span class="text-xl font-bold">Call</span><span class="text-sm opacity-90">${phoneStr}</span></a>
                    <a href="https://wa.me/91${cp}" target="_blank" class="w-full bg-[#25D366] text-white rounded-2xl py-6 flex flex-col items-center justify-center gap-2 shadow-lg active:scale-95 transition"><i class="ph-fill ph-whatsapp-logo text-4xl"></i><span class="text-xl font-bold">WhatsApp</span><span class="text-sm opacity-90">Open Chat</span></a>`;
            }

            handleTypeChange(s) {
                const t = document.getElementById('activityInputText'), d = document.getElementById('activityInputDate'), f = document.getElementById('activityInputFile');
                t.classList.add('hidden'); d.classList.add('hidden'); f.classList.add('hidden');
                t.required = false; d.required = false;
                if(s.value==='follow_up') { d.classList.remove('hidden'); d.required = true; }
                else if(s.value==='file') { f.classList.remove('hidden'); }
                else { t.classList.remove('hidden'); t.required = true; }
            }

            openLeadFromMenu(id) { ui.toggleMenu(false); setTimeout(() => this.editLead(id, 'activity'), 150); }
            formatCurrency(v) { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(v||0); }
            escapeHtml(s) { if(!s) return ''; return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        }

        const ui = {
            toggleModal: (s) => { 
                const m = document.getElementById('leadModal'); 
                if(s) { 
                    if(!document.getElementById('leadIdInput').value) { 
                        document.getElementById('modalTitle').textContent='New Lead'; 
                        document.getElementById('submitBtn').textContent='Save'; 
                        // Call App method safely
                        if (window.app && typeof window.app.switchModalTab === 'function') {
                             window.app.switchModalTab('info');
                             window.app.selectedInterests = []; 
                             window.app.renderInterestTags();
                        }
                        document.getElementById('tab-btn-activity').disabled=true; 
                        document.getElementById('tab-btn-contact').disabled=true; 
                    } 
                    m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); 
                } else { 
                    m.classList.remove('open'); 
                    setTimeout(()=>{m.classList.add('hidden'); document.getElementById('leadForm').reset(); document.getElementById('leadIdInput').value='';},300); 
                } 
            },
            toggleMenu: (s) => { const m = document.getElementById('sideMenu'); if(s) { try { window.app.renderFollowUps(); } catch(e){} m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); } else { m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); } },
            toggleLogs: (s) => { const m = document.getElementById('logsModal'); if(s) { try { window.app.renderLogs(); } catch(e){} m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('open')); } else { m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); } },
            toggleConfig: (s) => {
                const m = document.getElementById('configModal');
                if (s) {
                    try { window.app.renderUserList(); } catch (e) {}
                    m.classList.remove('hidden');
                    m.style.display = 'block'; // Force display
                    requestAnimationFrame(() => m.classList.add('open'));
                    setTimeout(() => {
                        if (m.classList.contains('hidden')) {
                            m.classList.remove('hidden');
                        }
                        if (!m.classList.contains('open')) {
                            m.classList.add('open');
                        }
                        m.style.display = 'block';
                    }, 500);
                } else {
                    m.classList.remove('open');
                    setTimeout(() => {
                        m.classList.add('hidden');
                        m.style.display = '';
                    }, 300);
                }
            },
            showLoading: (s) => { const l = document.getElementById('loadingOverlay'); if(s) l.classList.remove('hidden'); else l.classList.add('hidden'); }
        };

        // Attach ui to window before DOMContentLoaded so it's always available
        window.ui = ui;
        document.addEventListener('DOMContentLoaded', function() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');
            setTimeout(() => {
                const store = new LeadStore();
                window.app = new App(store);
                if (store.config.dbUrl) {
                    store.syncWithCloud().then(() => {
                        loadingOverlay.classList.add('hidden');
                    });
                } else {
                    // No dbUrl: show config modal and block login until set
                    loadingOverlay.classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    // Show config modal automatically
                    if (window.ui && typeof window.ui.toggleConfig === 'function') {
                        setTimeout(() => window.ui.toggleConfig(true), 300);
                    }
                }
            }, 0);
        });
    </script>
</body>
</html>